<?php/*+--------------------------------------------------------------------------|   Anwsion [#RELEASE_VERSION#]|   ========================================|   by Anwsion dev team|   (c) 2011 - 2012 Anwsion Software|   http://www.anwsion.com|   ========================================|   Support: zhengqiang@gmail.com|   +---------------------------------------------------------------------------*/if (!defined('IN_ANWSION')){	die;}class openid_qq_class extends AWS_MODEL{		function qq_login($callback)	{				return load_class('Services_Tencent_QQConnect_V2')->qq_login(get_setting('qq_login_app_id'), $callback);	}		function request_access_token($callback)	{		return load_class('Services_Tencent_QQConnect_V2')->qq_callback(get_setting('qq_login_app_id'), $callback, get_setting('qq_login_app_key'));	}		function request_user_info_by_token($access_token)	{		return load_class('Services_Tencent_QQConnect_V2')->get_user_info($access_token);	}		function get_user_info_by_open_id($open_id)	{		return $this->fetch_row('users_qq', 'type = \'qq\' AND name = \'' . $this->quote($open_id) . '\'');	}		function get_user_info_by_uid($uid)	{		return $this->fetch_row('users_qq', 'type = \'qq\' AND uid = ' . intval($uid));	}		function bind_account($uinfo, $redirect, $uid, $is_ajax = false)	{		if ($openid_info = $this->get_user_info_by_uid($uid))		{			if ($openid_info['name'] != $uinfo['openid'])			{				if ($is_ajax)				{					H::ajax_json_output(AWS_APP::RSM(null, -1, AWS_APP::lang()->_t('QQ 账号已经被其他账号绑定')));				}				else				{					H::redirect_msg(AWS_APP::lang()->_t('QQ 账号已经被其他账号绑定'), '/account/logout/');				}			}		}				if (! $users_qq = $this->get_user_info_by_open_id($uinfo['openid']))		{			if($uinfo['gender'] == '男')			{				$uinfo['gender'] = 'm';			}			else if($uinfo['gender'] == '女')			{				$uinfo['gender'] = 'f';			}			else			{				$uinfo['gender'] = 'n';			}						$users_qq = $this->user_add($uid, $uinfo['openid'], $uinfo['nickname'], $uinfo['gender']);						//第一次绑定，将头像迁移过来		}		else if ($users_qq['uid'] != $uid)		{			if ($is_ajax)			{				H::ajax_json_output(AWS_APP::RSM(null, "-1", 'QQ 已经被其他账号绑定'));			}			else			{				H::redirect_msg(AWS_APP::lang()->_t('QQ 已经被其他账号绑定'), '/account/setting/openid/');			}		}				$this->update_token($uinfo['openid'], AWS_APP::session()->QQConnect['access_token']);				if ($redirect)		{			HTTP::redirect($redirect);		}	}		function user_add($uid, $name, $nick, $gender)	{		return $this->insert('users_qq', array(			'type' => 'qq',			'uid' => intval($uid),			'name' => $name,			'nick' => $nick,			'gender' => $gender,			'add_time' => time(),		));	}		function update_token($openid, $access_token)	{		$this->update('users_qq', array(			'access_token' => $access_token		), 'type = \'qq\' AND name = \'' . $this->quote($openid) . '\'');	}		function del_user_by_uid($uid)	{		return $this->delete('users_qq', "type = 'qq' AND uid = " . intval($uid));	}}	